# 监控平台架构与需求落地清单

本文将需求逐条映射到可维护的模块化设计，确保后续改动只影响局部模块。

## 1. 监控目标
- **币安合约代币**：必须稳定监控，合约列表从币安接口自动拉取，前端可搜索/筛选/勾选，无需手填交易对格式。
- **链上代币**：优先名称搜索（期望通过 Binance Alpha 等接口覆盖），找不到再提示合约地址兜底；地址输入默认只需要 address，只有识别失败才补充链、symbol、name。
- 两类对象共享同一监控规则引擎与通知流。

## 2. 前端优先的使用体验
- 所有配置尽量在前端完成：代币搜索添加、监控参数、告警通道开关、endpoint 池管理、测试按钮。
- 添加流程类似搜索：输入名称 → 下拉联想 → 勾选 → 填阈值/比较方式/频率/冷却 → 启用。
- 必须有日志面板：展示运行状态、数据质量、错误原因、endpoint 切换记录。

## 3. 模块拆分与职责
- **UI & Config**：Streamlit/前端负责配置输入与展示，不写死可调参数到后端。
- **币种搜索与添加**：封装在数据提供者接口 `Provider` 中，名称优先、地址兜底，含 `list_futures_contracts()`、`search_tokens()`、`resolve_token()`。
- **监控参数面板**：绑定 `ThresholdRule`/`MonitoredTarget`，规则含比较方式、阈值、频率、冷却。
- **Endpoint 池管理**：前端 CRUD 排序 `EndpointEntry`，后端通过 `EndpointPool` 进行健康检查、重试与自动切换。
- **告警通道与测试按钮**：基于 `Notifier` 接口，DingTalk、本地声音必开支持，Telegram 预留；每个通道都有独立开关与 `self_test()`。
- **日志面板**：订阅事件总线，展示 `PriceAlertEvent`、`SystemFaultEvent`、`HealthStatus` 并区分价格事件与系统故障。
- **监控引擎**：只消费 `Provider` 行情并应用规则，产出事件，不关心数据源/通知实现细节。
- **健康与容灾**：`EndpointPool` + 健康检查结果，记录失败原因、重试、切换决策，全量失败需触发系统故障事件并走告警通道。
- **事件总线**：`EventBus` 统一转发结构化事件，避免模块直连耦合。

## 4. 数据与接口策略
- 数据源限定为 Binance 家族：合约走 Futures，链上优先 Alpha，覆盖不到再用地址兜底。
- Endpoint 池支持多 base url、可选 API Key，前端可新增/编辑/删除/排序；运行时自动健康检查、重试与故障切换，并把切换日志化。
- 故障分类：网络不可达、API 超时/错误码/限频、全部 endpoint 失败。必须记录尝试过的 endpoint、原因与最终结论，并触发系统故障告警。

## 5. 模块间通信约束
- 仅通过明确接口（`Provider`/`Notifier` 等）、事件总线或共享类型（`core.events`、`core.config_models`）交互。
- 禁止跨模块直接访问私有状态或散落 if/else；新增通道或数据源只需新增模块与注册，不改引擎核心逻辑。

## 6. 可替换性验收
- 更换 Telegram 通知：只改对应 notifier 模块与注册，不改引擎/数据源。
- 替换链上数据提供者：只调整 provider 实现与少量配置，不改 UI 结构与引擎逻辑。
- 修改前端配置 UI：不影响监控引擎；新增 endpoint 类型不需要全局重构。

## 7. 下一步实施建议
1. 将现有前端配置页与 `AppConfig` 模型对齐，驱动监控引擎所需的目标、规则、endpoint 池与通道开关。
2. 完成币安 Futures 与链上 provider 适配，实现名称联想、地址兜底、合约列表获取。
3. 将监控引擎接入事件总线，按规则产出 `PriceAlertEvent`，并在系统故障时产出 `SystemFaultEvent`。
4. 扩展健康检查任务，周期性探测 endpoint，记录失败原因并触发自动切换，同时把 `HealthStatus` 投递到日志面板。
